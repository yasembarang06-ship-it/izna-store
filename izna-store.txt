import streamlit as st
import sqlite3
import os
from datetime import datetime

# --- KONFIGURASI ---
st.set_page_config(
page_title="Izna Store - Toko Kebutuhan Konten Kreator",
page_icon="ğŸ›’",
layout="wide"
)

UPLOAD_DIR = "uploads"
os.makedirs(UPLOAD_DIR, exist_ok=True)

# --- DATABASE ---
def init_db():
conn = sqlite3.connect('izna_store.db')
c = conn.cursor()

# Tabel produk
c.execute('''
CREATE TABLE IF NOT EXISTS products (
id INTEGER PRIMARY KEY AUTOINCREMENT,
kategori TEXT,
nama_produk TEXT,
deskripsi TEXT,
harga INTEGER,
gambar TEXT,
stok INTEGER,
created_at TIMESTAMP
)
''')

# Tabel pesanan
c.execute('''
CREATE TABLE IF NOT EXISTS orders (
id INTEGER PRIMARY KEY AUTOINCREMENT,
customer_name TEXT,
customer_email TEXT,
customer_wa TEXT,
produk TEXT,
total_harga INTEGER,
metode_pembayaran TEXT,
status_pembayaran TEXT,
bukti_transfer TEXT,
status_order TEXT,
created_at TIMESTAMP
)
''')

conn.commit()
conn.close()

def add_product(kategori, nama, deskripsi, harga, gambar, stok):
gambar_path = ""
if gambar:
gambar_path = os.path.join(UPLOAD_DIR, f"{datetime.now().timestamp()}_{gambar.name}")
with open(gambar_path, "wb") as f:
f.write(gambar.getbuffer())

conn = sqlite3.connect('izna_store.db')
c = conn.cursor()
c.execute('''INSERT INTO products (kategori, nama_produk, deskripsi, harga, gambar, stok, created_at)
VALUES (?, ?, ?, ?, ?, ?, ?)''',
(kategori, nama, deskripsi, harga, gambar_path, stok, datetime.now()))
conn.commit()
conn.close()

def update_product(product_id, kategori, nama, deskripsi, harga, gambar, stok):
conn = sqlite3.connect('izna_store.db')
c = conn.cursor()

# Cek apakah ada gambar baru
if gambar:
gambar_path = os.path.join(UPLOAD_DIR, f"{datetime.now().timestamp()}_{gambar.name}")
with open(gambar_path, "wb") as f:
f.write(gambar.getbuffer())
c.execute('''UPDATE products SET kategori=?, nama_produk=?, deskripsi=?, harga=?, gambar=?, stok=? WHERE id=?''',
(kategori, nama, deskripsi, harga, gambar_path, stok, product_id))
else:
# Tetap gunakan gambar lama
c.execute('''UPDATE products SET kategori=?, nama_produk=?, deskripsi=?, harga=?, stok=? WHERE id=?''',
(kategori, nama, deskripsi, harga, stok, product_id))

conn.commit()
conn.close()

def get_products(kategori=None):
conn = sqlite3.connect('izna_store.db')
c = conn.cursor()
if kategori:
c.execute('SELECT * FROM products WHERE kategori = ? ORDER BY created_at DESC', (kategori,))
else:
c.execute('SELECT * FROM products ORDER BY created_at DESC')
data = c.fetchall()
conn.close()
return data

def get_product_by_id(product_id):
conn = sqlite3.connect('izna_store.db')
c = conn.cursor()
c.execute('SELECT * FROM products WHERE id = ?', (product_id,))
data = c.fetchone()
conn.close()
return data

def delete_product(product_id):
conn = sqlite3.connect('izna_store.db')
c = conn.cursor()
c.execute('DELETE FROM products WHERE id = ?', (product_id,))
conn.commit()
conn.close()

def add_order(name, email, wa, produk_list, total, metode_pembayaran, bukti_file=None):
produk_str = ", ".join([f"{p['nama']} x{p['jumlah']}" for p in produk_list])

bukti_path = ""
if bukti_file:
bukti_path = os.path.join(UPLOAD_DIR, f"bukti_{datetime.now().timestamp()}_{bukti_file.name}")
with open(bukti_path, "wb") as f:
f.write(bukti_file.getbuffer())

conn = sqlite3.connect('izna_store.db')
c = conn.cursor()
c.execute('''INSERT INTO orders
(customer_name, customer_email, customer_wa, produk, total_harga, metode_pembayaran, status_pembayaran, bukti_transfer, status_order, created_at)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)''',
(name, email, wa, produk_str, total, metode_pembayaran, "Menunggu Konfirmasi", bukti_path, "Menunggu", datetime.now()))
conn.commit()
order_id = c.lastrowid
conn.close()
return order_id

def get_orders():
conn = sqlite3.connect('izna_store.db')
c = conn.cursor()
c.execute('SELECT * FROM orders ORDER BY created_at DESC')
data = c.fetchall()
conn.close()
return data

def update_status_order(order_id, status):
conn = sqlite3.connect('izna_store.db')
c = conn.cursor()
c.execute('UPDATE orders SET status_order = ?, status_pembayaran = ? WHERE id = ?',
(status, "Dikonfirmasi" if status == "Diproses" else status, order_id))
conn.commit()
conn.close()

# --- SESSION STATE ---
if 'cart' not in st.session_state:
st.session_state.cart = []

if 'checkout_data' not in st.session_state:
st.session_state.checkout_data = None

# --- FUNGSI HELPER ---
def format_rupiah(angka):
return f"Rp {angka:,}".replace(",", ".")

def add_to_cart(product):
for item in st.session_state.cart:
if item['id'] == product[0]:
item['jumlah'] += 1
st.success(f"{product[2]} ditambahkan ke keranjang!")
return
st.session_state.cart.append({
'id': product[0],
'nama': product[2],
'harga': product[4],
'jumlah': 1
})
st.success(f"{product[2]} ditambahkan ke keranjang!")

def remove_from_cart(index):
st.session_state.cart.pop(index)

# --- MAIN APP ---
def main():
init_db()

# Custom CSS
st.markdown("""
<style>
.stButton > button {
width: 100%;
}
</style>
""", unsafe_allow_html=True)

# Sidebar
with st.sidebar:
st.title("ğŸ›’ Izna Store")
st.markdown("---")

# Menu
menu = st.radio("ğŸ“Œ Menu", ["ğŸ  Beranda", "ğŸ›’ Keranjang", "ğŸ“¦ Pesanan Saya", "âš™ï¸ Admin"])

# Kategori
st.markdown("---")
st.subheader("ğŸ“‚ Kategori")
kategori_filter = st.selectbox("Filter",
["Semua", "AI Tools", "CapCut Premium", "Alat Konten", "Template", "VPS", "Akun Premium", "Lainnya"])

st.markdown("---")
if st.session_state.cart:
total_items = sum(item['jumlah'] for item in st.session_state.cart)
total_harga = sum(item['harga'] * item['jumlah'] for item in st.session_state.cart)
st.success(f"ğŸ›’ Keranjang: {total_items} item\n\nTotal: {format_rupiah(total_harga)}")
else:
st.info("ğŸ›’ Keranjang kosong")

# === HALAMAN BERANDA ===
if menu == "ğŸ  Beranda":
st.markdown("""
<div style="background: linear-gradient(90deg, #667eea, #764ba2); padding: 30px; border-radius: 15px; text-align: center; color: white; margin-bottom: 30px;">
<h1 style="margin: 0;">ğŸ›’ Izna Store</h1>
<p style="margin: 10px 0 0 0; font-size: 18px;">Toko Kebutuhan Konten Kreator Terlengkap</p>
</div>
""", unsafe_allow_html=True)

st.markdown("""
<div style="background: linear-gradient(90deg, #f093fb, #f5576c); padding: 20px; border-radius: 10px; text-align: center; color: white; margin-bottom: 20px;">
<h3>ğŸ”¥ Promo Spesial!</h3>
<p>CapCut Pro & Gemini Pro dengan harga terbaik!</p>
</div>
""", unsafe_allow_html=True)

kat = None if kategori_filter == "Semua" else kategori_filter
products = get_products(kat)

if not products:
st.warning("âš ï¸ Produk belum tersedia. Silakan tambah di menu Admin.")
else:
cols = st.columns(4)
for i, prod in enumerate(products):
with cols[i % 4]:
with st.container():
if prod[5] and os.path.exists(prod[5]):
st.image(prod[5], use_container_width=True)
else:
st.markdown("""
<div style="background: #f0f0f0; height: 150px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">
<span style="font-size: 50px;">ğŸ“¦</span>
</div>
""", unsafe_allow_html=True)

st.markdown(f"**{prod[2]}**")

if prod[3]:
with st.expander("ğŸ“ Deskripsi"):
st.markdown(f"<p>{prod[3]}</p>", unsafe_allow_html=True)

st.markdown(f"ğŸ’° **{format_rupiah(prod[4])}**")
st.markdown(f"ğŸ“¦ Stok: {prod[6]}")

if st.button(f"ğŸ›’ Tambah ke Keranjang", key=f"add_{prod[0]}"):
add_to_cart(prod)

st.markdown("---")

# === HALAMAN KERANJANG ===
elif menu == "ğŸ›’ Keranjang":
st.title("ğŸ›’ Keranjang Belanja")

if not st.session_state.cart:
st.info("Keranjang Anda kosong!")
if st.button("ğŸ  Kembali ke Beranda"):
st.rerun()
else:
total = 0
for i, item in enumerate(st.session_state.cart):
col1, col2, col3, col4 = st.columns([3, 1, 1, 1])
with col1:
st.markdown(f"**{item['nama']}**")
with col2:
st.markdown(f"x{item['jumlah']}")
with col3:
st.markdown(format_rupiah(item['harga'] * item['jumlah']))
total += item['harga'] * item['jumlah']
with col4:
if st.button("ğŸ—‘ï¸ Hapus", key=f"del_{i}"):
remove_from_cart(i)
st.rerun()

st.markdown("---")
st.markdown(f"### ğŸ’° Total: **{format_rupiah(total)}**")

col_clear, col_checkout = st.columns([1, 2])
with col_clear:
if st.button("ğŸ—‘ï¸ Kosongkan Keranjang"):
st.session_state.cart = []
st.rerun()

st.markdown("---")
st.markdown("## ğŸ“ Form Pemesanan")

with st.form("checkout_form"):
col1, col2 = st.columns(2)
with col1:
nama = st.text_input("ğŸ‘¤ Nama Lengkap *")
email = st.text_input("ğŸ“§ Email *")
with col2:
wa = st.text_input("ğŸ“± No. WhatsApp *")

st.markdown("### ğŸ’³ Pilih Metode Pembayaran")
metode = st.radio("Metode:", ["ğŸ’µ Transfer Bank", "ğŸ“± QRIS (QR Code)"])

bukti = None
if metode == "ğŸ’µ Transfer Bank":
st.markdown("""
<div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 10px 0;">
<h4>ğŸ¦ Rekening Pembayaran:</h4>
<p><b>BCA:</b> 1234567890 (Izna Store)</p>
<p><b>BRI:</b> 9876543210 (Izna Store)</p>
<p><b>Mandiri:</b> 1122334455 (Izna Store)</p>
</div>
""", unsafe_allow_html=True)
bukti = st.file_upload("ğŸ“¤ Upload Bukti Transfer", type=['jpg', 'png', 'jpeg'])

else:
st.markdown("""
<div style="background: #fff3e0; padding: 15px; border-radius: 10px; margin: 10px 0; text-align: center;">
<h4>ğŸ“± Scan QRIS</h4>
<div style="background: white; padding: 10px; display: inline-block; border-radius: 10px;">
<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=IznaStore" width="200">
</div>
<p><b>Total:</b> {}</p>
</div>
""".format(format_rupiah(total)), unsafe_allow_html=True)
bukti = st.file_upload("ğŸ“¤ Upload Bukti Pembayaran", type=['jpg', 'png', 'jpeg'])

submit = st.form_submit_button("âœ… Pesan Sekarang")

if submit:
if nama and email and wa:
order_id = add_order(nama, email, wa, st.session_state.cart, total, metode, bukti)
st.session_state.cart = []
st.session_state.checkout_data = {
'order_id': order_id,
'nama': nama,
'total': total,
'metode': metode
}
st.rerun()
else:
st.error("Mohon isi semua data!")

# === HALAMAN PESANAN ===
elif menu == "ğŸ“¦ Pesanan Saya":
st.title("ğŸ“¦ Pesanan Saya")

if st.session_state.checkout_data:
data = st.session_state.checkout_data
st.markdown(f"""
<div style="background: #d4edda; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
<h3>âœ… Pesanan Berhasil!</h3>
<p><b>No. Pesanan:</b> #{data['order_id']}</p>
<p><b>Nama:</b> {data['nama']}</p>
<p><b>Total:</b> {format_rupiah(data['total'])}</p>
<p><b>Metode:</b> {data['metode']}</p>
</div>
""", unsafe_allow_html=True)

if st.button("ğŸ›’ Belanja Lagi"):
st.session_state.checkout_data = None
st.rerun()

orders = get_orders()
if orders:
st.markdown("### ğŸ“‹ Riwayat Pesanan")
for order in orders:
status_color = "ğŸŸ¡" if order[9] == "Menunggu" else "ğŸŸ¢"
with st.expander(f"{status_color} Pesanan #{order[0]} - {order[9]}"):
st.write(f"**Nama:** {order[1]}")
st.write(f"**Email:** {order[2]}")
st.write(f"**WA:** {order[3]}")
st.write(f"**Produk:** {order[4]}")
st.write(f"**Total:** {format_rupiah(order[5])}")
st.write(f"**Status:** {order[9]}")
else:
st.info("Belum ada pesanan.")

# === HALAMAN ADMIN (FULL KONTROL) ===
elif menu == "âš™ï¸ Admin":
st.title("âš™ï¸ Panel Admin Izna Store")
st.markdown("---")

tab1, tab2, tab3 = st.tabs(["ğŸ“‹ Daftar Produk", "â• Tambah Produk", "ğŸ“¦ Kelola Pesanan"])

# === TAB 1: DAFTAR & EDIT PRODUK ===
with tab1:
st.subheader("ğŸ“‹ Kelola Semua Produk")
products = get_products()

if not products:
st.warning("Belum ada produk. Silakan tambah produk di tab 'Tambah Produk'.")

for prod in products:
with st.expander(f"ğŸ“¦ {prod[2]} - {format_rupiah(prod[4])}"):
# Form Edit Produk
with st.form(f"edit_form_{prod[0]}"):
col1, col2 = st.columns(2)

with col1:
edit_kategori = st.selectbox("Kategori",
["AI Tools", "CapCut Premium", "Alat Konten", "Template", "